/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var t={maxAttempts:3,retryableStatuses:[429,502,503,504],backoffMs:1e3,maxBackoffMs:1e4,backoffMultiplier:2},e={timeout:3e4,parseResponse:!0,validateStatus:t=>t<400},r=class t extends Error{constructor(e,r,n=!1,s,a){super(e),this.statusCode=r,this.retryable=n,this.responseBody=s,this.responseHeaders=a,this.name="TransmissionError",Object.setPrototypeOf(this,t.prototype)}},n=class t extends r{constructor(e,r){super(`${e} (timeout: ${r}ms)`,void 0,!0),this.name="TimeoutError",Object.setPrototypeOf(this,t.prototype)}},s=class t extends r{constructor(e,r){super(e,void 0,!0),this.name="NetworkError",r&&(this.cause=r),Object.setPrototypeOf(this,t.prototype)}},a=class t extends Error{constructor(e){super(e),this.name="ValidationError",Object.setPrototypeOf(this,t.prototype)}};function o(t,e,r){if(void 0!==r&&r>0)return Math.min(r,e.maxBackoffMs);const n=e.backoffMs*Math.pow(e.backoffMultiplier,t-1),s=Math.min(n,e.maxBackoffMs),a=.25*s,o=s-a,i=s+a;return Math.floor(Math.random()*(i-o)+o)}function i(t){if(!t)return;const e=parseInt(t,10);if(!isNaN(e))return 1e3*e;const r=new Date(t);if(!isNaN(r.getTime())){const t=r.getTime()-Date.now();return t>0?t:void 0}}function c(t,e,r){return!(e>=r.maxAttempts)&&(void 0===t||function(t,e){return e.includes(t)}(t,r.retryableStatuses))}async function u(t){return new Promise(e=>setTimeout(e,t))}function l(t){const e={};return t.forEach((t,r)=>{e[r]=t}),e}async function d(t,e){const r=await t.text();if(!e||!r)return r;const n=t.headers.get("content-type");if(n?.includes("application/json"))try{return JSON.parse(r)}catch{return r}return r}async function p(t){const e=t.environment||{},r=t.secrets||{};if(r.BEARER_AUTH_TOKEN){const t=r.BEARER_AUTH_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.BASIC_PASSWORD&&r.BASIC_USERNAME){return`Basic ${btoa(`${r.BASIC_USERNAME}:${r.BASIC_PASSWORD}`)}`}if(r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const t=r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const t=e.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,n=e.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,s=r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!t||!n)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const a=await async function(t){const{tokenUrl:e,clientId:r,clientSecret:n,scope:s,audience:a,authStyle:o}=t;if(!e||!r||!n)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const i=new URLSearchParams;i.append("grant_type","client_credentials"),s&&i.append("scope",s),a&&i.append("audience",a);const c={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if("InParams"===o)i.append("client_id",r),i.append("client_secret",n);else{const t=btoa(`${r}:${n}`);c.Authorization=`Basic ${t}`}const u=await fetch(e,{method:"POST",headers:c,body:i.toString()});if(!u.ok){let t;try{const e=await u.json();t=JSON.stringify(e)}catch{t=await u.text()}throw new Error(`OAuth2 token request failed: ${u.status} ${u.statusText} - ${t}`)}const l=await u.json();if(!l.access_token)throw new Error("No access_token in OAuth2 response");return l.access_token}({tokenUrl:t,clientId:n,clientSecret:s,scope:e.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:e.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:e.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${a}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}const f="https://schemas.openid.net/secevent/caep/event-type/assurance-level-change";function E(t){if(!t)return t;try{const e=JSON.parse(t);if("object"==typeof e&&null!==e)return e}catch{}return t}var h={invoke:async(h,_)=>{const T=function(t,e){const r=e.environment||{},n=t?.address||r.ADDRESS;if(!n)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return n.endsWith("/")?n.slice(0,-1):n}(h,_),A=await p(_),m=function(t){try{return JSON.parse(t)}catch(t){throw new Error(`Invalid subject JSON: ${t.message}`)}}(h.subject),y={event_timestamp:Math.floor(Date.now()/1e3),namespace:h.namespace,current_level:h.current_level};h.previous_level&&(y.previous_level=h.previous_level),h.change_direction&&(y.change_direction=h.change_direction),h.initiating_entity&&(y.initiating_entity=h.initiating_entity),h.reason_admin&&(y.reason_admin=E(h.reason_admin)),h.reason_user&&(y.reason_user=E(h.reason_user));const S={aud:h.audience,sub_id:m,events:{[f]:y}},w=await async function(t,e){const{iss:r,iat:n,jti:s,exp:a,nbf:o,...i}=e;return(r||n||s||a||o)&&console.warn("signSET: Reserved claims (iss, iat, jti, exp, nbf) are set automatically and will be ignored"),await t.crypto.signJWT(i,{typ:"secevent+jwt"})}(_,S);return await async function(p,f,E={}){if(!function(t){if("string"!=typeof t)return!1;const e=t.split(".");if(3!==e.length)return!1;const r=/^[A-Za-z0-9_-]+$/;return e.every(t=>r.test(t))}(p))throw new a("Invalid SET format: JWT must be in format header.payload.signature");let h;try{h=new URL(f)}catch{throw new a(`Invalid URL: ${f}`)}const _={authToken:E.authToken,headers:E.headers||{},timeout:E.timeout??e.timeout,parseResponse:E.parseResponse??e.parseResponse,validateStatus:E.validateStatus??e.validateStatus,retry:{...t,...E.retry||{}}},T={"Content-Type":"application/secevent+jwt",Accept:"application/json","User-Agent":"SGNL-Action-Framework/1.0"},A=function(t){if(t)return t.startsWith("Bearer ")?t:`Bearer ${t}`}(_.authToken);A&&(T.Authorization=A);const m=(y=T,S=_.headers,{...y,...S});var y,S;let w,C;for(let t=1;t<=_.retry.maxAttempts;t++)try{const e=new AbortController,r=setTimeout(()=>e.abort(),_.timeout);try{const n=await fetch(h.toString(),{method:"POST",headers:m,body:p,signal:e.signal});clearTimeout(r),C=n;const s=l(n.headers),a=await d(n,_.parseResponse);if(_.validateStatus(n.status))return{status:"success",statusCode:n.status,body:a,headers:s};if(!c(n.status,t,_.retry))return{status:"failed",statusCode:n.status,body:a,headers:s,error:`HTTP ${n.status}: ${n.statusText}`,retryable:_.retry.retryableStatuses.includes(n.status)};const f=i(s["retry-after"]),E=o(t,_.retry,f);await u(E)}catch(e){if(clearTimeout(r),w=e instanceof Error?"AbortError"===e.name?new n("Request timed out",_.timeout):new s(`Network error: ${e.message}`,e):new s("Unknown network error"),!c(void 0,t,_.retry))throw w;const a=o(t,_.retry);await u(a)}}catch(t){if(t instanceof a)throw t;w=t instanceof Error?t:new Error(String(t))}if(C){const t=l(C.headers);let e="";try{e=await d(C,_.parseResponse)}catch{e=""}return{status:"failed",statusCode:C.status,body:e,headers:t,error:w?.message||`HTTP ${C.status}: ${C.statusText}`,retryable:!0}}throw w||new r("Failed to transmit SET after all retry attempts",void 0,!0)}(w,T,{headers:{Authorization:A,"User-Agent":"SGNL-CAEP-Hub/2.0"}})},error:async(t,e)=>{const{error:r}=t;if(r.message?.includes("429")||r.message?.includes("502")||r.message?.includes("503")||r.message?.includes("504"))return{status:"retry_requested"};throw r},halt:async(t,e)=>({status:"halted"})};module.exports=h;
